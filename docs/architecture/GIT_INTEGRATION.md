# Git Integration (GitHub Connector)

## Overview

Glubean supports a **"Zero-CLI"** workflow by connecting directly to your GitHub repositories. This allows for automatic deployments and preview environments without requiring developers to manually run `glubean sync`.

## Workflow

```mermaid
graph TD
    User[User] -->|1. Connect| GitHub[GitHub App]
    GitHub -->|2. Webhook (Push)| Glubean[Glubean Platform]

    Glubean -->|3. Clone & Analyze| Builder[Build Service]
    Builder -->|4. Upload| Registry[S3 Registry]

    Builder -->|5. Notify| GitHub
```

## 1. Connection Setup

1.  **Install GitHub App:** User installs "Glubean" GitHub App on their organization/repo.
2.  **Select Repo:** In Glubean Dashboard, user selects `my-org/api-tests`.
3.  **Configure:**
    - **Branch:** `main` (Production).
    - **Root Directory:** `./tests` (Optional, if tests aren't in root).
    - **Auto-Deploy:** `true` (Deploy on every push).

## 2. The Build Pipeline

When Glubean receives a `push` webhook:

1.  **Provision Builder:** Spin up a lightweight container (or Deno task).
2.  **Clone:** Shallow clone the repository at the specific commit SHA.
3.  **Analysis (Metadata Validation):**
    - Require `metadata.json` in the repo (generated by `glubean scan` or CI).
    - Validate schemaVersion and rootHash before building the bundle.
    - If missing or invalid, the build fails.
4.  **Upload:**
    - Upload source files to `s3://registry/projects/{id}/commits/{sha}/`.
    - Upload metadata.
5.  **Register:** Update the Glubean Database:
    - Create `Deployment` record linked to Commit SHA.
    - Update `TestDefinition` records.

**Note:** With strict metadata enforcement, the first push may fail if `metadata.json` is missing. CI can generate and push `metadata.json`, and the next push succeeds.

## 3. Preview Environments (Pull Requests)

When a **Pull Request** is opened or updated:

1.  **Trigger:** GitHub sends `pull_request` webhook.
2.  **Build:** Glubean builds a temporary "Preview Bundle" from the PR branch.
3.  **Run (Optional):** If configured, Glubean automatically runs the tests against a Preview URL.
    - _Integration:_ If using Vercel/Netlify, Glubean waits for their deployment to finish, grabs the `PREVIEW_URL`, and injects it as `$vars.BASE_URL`.
4.  **Report:** Glubean posts a comment on the PR:
    > **Glubean Tests:** âœ… 45 Passed, 0 Failed. [View Report](...)

## 4. Implementation Details

### 4.1 GitHub App Permissions

- `contents: read` (To clone code).
- `pull_requests: write` (To post comments).
- `checks: write` (To update commit status checks).

### 4.2 The "Builder" Service

This is a specialized worker separate from the Test Runner.

- **Input:** Repo URL, Commit SHA.
- **Output:** S3 Bundle URL, Metadata.
- **Tech:** Can be a simple Deno script that uses `simple-git` or GitHub API to fetch tarballs (faster than git clone).

## 5. User Value

- **No Setup:** Developers don't need to install `glubean` CLI locally.
- **CI/CD Included:** No need to write `.github/workflows/test.yml`. It just works.
- **Visibility:** Test results appear directly in GitHub PRs.
